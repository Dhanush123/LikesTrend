<!DOCTYPE html>
<html>
<head>
  <title>Likes Trend</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ct" content="<$= ct $>">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script> 
  
    <script type = "text/javascript"  src="Chart.min.js"></script>
</head>


<body>
    
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Likes Trend</a>
        </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Find out how popular you are on Facebook!</h1>
        <p>Simply click the Facebook "Log In" button, wait no more than 30 seconds on average, and a graph will appear showing the likes across the last 275 posts on your wall (both the ones made by you and the ones you were tagged in). Enjoy!</p>
                      <!--
        Below we include the Login Button social plugin. This button uses
        the JavaScript SDK to present a graphical Login button that triggers
        the FB.login() function when clicked.
      -->  <fb:login-button scope="public_profile,email,user_posts" onlogin="checkLoginState();" data-max-rows="1" data-size="large" data-show-faces="true" data-auto-logout-link="false">
        </fb:login-button>
    
      </div>
    </div>
  <script>
    var postsDates = [];
    var postsIDS = [];
    var postNumLikes = [];  
    
        // This is called with the results from from FB.getLoginStatus().
    function statusChangeCallback(response) {
      console.log('statusChangeCallback');
      console.log(response);
      // The response object is returned with a status field that lets the
      // app know the current login status of the person.
      // Full docs on the response object can be found in the documentation
      // for FB.getLoginStatus().
      if (response.status === 'connected') {
        // Logged into your app and Facebook.
        testAPI();
      } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.

      } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.

      }
    }
      
    // This function is called when someone finishes with the Login
    // Button.  See the onlogin handler attached to it in the sample
    // code below.
    function checkLoginState() {
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }
      
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '929095907204857',
      xfbml      : true,
      version    : 'v2.5'
    });


    // Now that we've initialized the JavaScript SDK, we call
    // FB.getLoginStatus().  This function gets the state of the
    // person visiting this page and can return one of three states to
    // the callback you provide.  They can be:
    //
    // 1. Logged into your app ('connected')
    // 2. Logged into Facebook, but not your app ('not_authorized')
    // 3. Not logged into Facebook and can't tell if they are logged into
    //    your app or not.
    //
    // These three cases are handled in the callback function.
      
     FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
     };
      
        (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
      
    // Here we run a very simple test of the Graph API after login is
    // successful.  See statusChangeCallback() for when this call is made.
    function testAPI() {
      console.log('Welcome!  Fetching your information.... ');
      var initParam1 = '/me/feed?limit=200';  
      getFBPosts(initParam1);      
      //only getting 274? back tho..
    } 
    
    function getCurrentDate(){
         var today = new Date();
         var date = today.getDate();
         var month = today.getMonth(); 
         var year = today.getFullYear();

         if(date<10) {
            date='0'+date;
         } 

         if(month<10) {
            month='0'+month;
         } 
          
        var todayNew = new Date(year,month,date);  
        console.log("Today's date: "+todayNew.toDateString());
        return todayNew;
    }
      
    function dateDiff(d1, d2) {
       var diff = (Math.abs(d1.getTime() - d2.getTime()))/ (1000 * 60 * 60 * 24);
       console.log("Days diff b/w these posts: "+diff);    
       return diff;    
    }
      
    var gotPostsOnce = false;
      
    function getFBPosts(paramPass) {
        
      var todayD = getCurrentDate();
      var responseSize = 0;
      var index = 0;
      var morePosts;
      var nextLinkParam;    
      FB.api(
        paramPass,
        'GET',
        {},
          function(response) { 
                parsePosts(response);
           });  
    }
           
    function parsePosts(response) {
        
      var todayD = getCurrentDate();
      var responseSize = 0;
      var index = 0;
      var morePosts;
      var nextLinkParam;    
              
          response.paging.next==undefined ? morePosts = false : (morePosts = true,nextLinkParam=response.paging.next);
                
          responseSize = response.data.length;       
          for(var k in response.data) {
              
            var postYear = response.data[k].created_time.substring(0,4);
            var postDate = response.data[k].created_time.substring(5,7);
            var postMonth = response.data[k].created_time.substring(8,10);
            var postD = new Date(postYear,postMonth,postDate);  
            console.log("Date of post: "+postDate+"/"+postMonth+"/"+postYear);  
            if(dateDiff(todayD,postD)<=365){  
                var postID = response.data[k].id;
                postsIDS[index] = postID;
                postsDates[index] = response.data[k].created_time;
                console.log("got post ID: "+postsIDS[index]);  
                index++;
            }  
           }    
        
              if(morePosts==false){
                  console.log("postsIDS.length = "+postsIDS.length+", responseSize = "+responseSize);  
                  console.log("postsDates.length = "+postsDates.length+", responseSize = "+responseSize);
                  getNumLikes(); 
              }
              else{
                  getFBPosts(nextLinkParam);
              } 
    }
      
    function getNumLikes(){
        for (var k = 0; k < postsIDS.length; k++){
            (function(k) {
            var postID = postsIDS[k];
            var url = '/'+postID+'/likes';
               FB.api(
               url,
              'GET',
              {"summary":"true"},
              function(response) {
                  console.log('response to likes API call: '+response);
                  if(response.summary.total_count==undefined){
                         postsDates.splice(k,1); //just don't even display that post then
                   }
                  else{
                       postNumLikes[k] = response.summary.total_count;
                  }
                  console.log("postNumLikes["+k+"] = "+postNumLikes[k]);
              }
            );
        })(k);
    }    
    setTimeout(drawGraph,15000);
    }
      
      function drawGraph() {   
        console.log("inside graph method now"); 
        
        postsDates.reverse();  
        var postDates = postsDates.slice(0);
        
        var postDates1 = [];
        
        for(var i in postDates) {
            postDates1[i] = (postDates[i].substring(0,10));
        }
        console.log("# dates to be used in graph: "+postDates1.length);  
        console.log("dates to be used in graph: "+postDates1);          
          
        
        postNumLikes.reverse();  
        var postData = postNumLikes.slice(0);
        console.log("# likes to be used in graph: "+postData.length);  
        console.log("likes to be used in graph: "+postData);  
        
		var randomScalingFactor = function(){ return Math.round(Math.random()*100)};
		var lineChartData = {
			labels : postDates1,
			datasets : [
				{
					label: "Likes vs. Time Data",
					fillColor : "rgba(1, 255, 255, 0.5)",
					strokeColor : "rgba(81, 95, 93, 0.4)",
					pointColor : "rgba(255, 0, 0, 0.7)",
					pointStrokeColor : "#fff",
					pointHighlightFill : "#fff",
					pointHighlightStroke : "rgba(220,220,220,1)",
                    showXLabels: 5,
                    pointHitDetectionRadius : 10,
					data : postData
				},
			]
		}
		var ctx = document.getElementById("canvas").getContext("2d");
		window.myLine = new Chart(ctx).Line(lineChartData, {
			responsive: true
		});
        }
      
  </script>
            <canvas id="canvas" width="400" height="400"></canvas>
    
</body>
    