<!DOCTYPE html>
<html>
<head>
  <title>Likes Trend</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ct" content="<$= ct $>">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script> 
  
    <script type = "text/javascript"  src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
</head>


<body>
  <script>
    var postsDates = [];
    var postsIDS = [];
    var postNumLikes = [];  
      
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '929095907204857',
      xfbml      : true,
      version    : 'v2.5'
    });
      
          FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

    // Now that we've initialized the JavaScript SDK, we call
    // FB.getLoginStatus().  This function gets the state of the
    // person visiting this page and can return one of three states to
    // the callback you provide.  They can be:
    //
    // 1. Logged into your app ('connected')
    // 2. Logged into Facebook, but not your app ('not_authorized')
    // 3. Not logged into Facebook and can't tell if they are logged into
    //    your app or not.
    //
    // These three cases are handled in the callback function.
      
        // This is called with the results from from FB.getLoginStatus().
    function statusChangeCallback(response) {
      console.log('statusChangeCallback');
      console.log(response);
      // The response object is returned with a status field that lets the
      // app know the current login status of the person.
      // Full docs on the response object can be found in the documentation
      // for FB.getLoginStatus().
      if (response.status === 'connected') {
        // Logged into your app and Facebook.
        testAPI();
      } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.

      } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.

      }
    }

    // Here we run a very simple test of the Graph API after login is
    // successful.  See statusChangeCallback() for when this call is made.
    function testAPI() {
      console.log('Welcome!  Fetching your information.... ');
      getFBPosts();  
      //only getting 274? back tho..
    } 
    function getFBPosts() {
      var responseSize = 0;
      var index = 0;
      FB.api(
        '/me/feed?limit=1000',
        'GET',
        {},
           function(response) {
          responseSize = response.data.length;       
          for(var k in response.data) {
            var postID = response.data[k].id;
            postsIDS[index] = postID;
            console.log("got post ID: "+postsIDS[index]);  
            index++;
          }  
             console.log("postsIDS.length = "+postsIDS.length+", responseSize = "+responseSize);  
             getFBPosts2();
            // Insert your code here
           }
      ); 
//      while(postsIDS.length!=responseSize){
//          console.log('working on IDs...');
//      }    
//      if(postsIDS.length==responseSize){
//          console.log("going to dates methods now!");
//          getFBPosts2();
//      } 
//      else{
//          console.log("postsIDS.length = "+postsIDS.length+", responseSize = "+responseSize);
//          console.log("I'm such a terrible coder...");
//      }    
        
    }
      function getFBPosts2() {
          var responseSize = 0;
          var index = 0;
          FB.api(
            '/me/feed?limit=1000',
            'GET',
            {},
               function(response) {
              responseSize = response.data.length;         
              for(var k in response.data) {
                var postDate = response.data[k].created_time;  
                postsDates[index] = postDate;
                index++;
              }  
                 console.log("postsDates.length = "+postsDates.length+", responseSize = "+responseSize);  
                 getNumLikes();         
                // Insert your code here
               }
          ); 
      }
//      while(postsDates.length!=responseSize){
//          console.log('working on dates...');
//      }    
//      if(postsDates.length==responseSize){
//          console.log("going to likes methods now!");
//          getNumLikes();
//      }       
//    }
      
    function getNumLikes(){
        for (var k = 0; k < postsIDS.length; k++){
            (function(k) {
            var postID = postsIDS[k];
            var url = '/'+postID+'/likes';
               FB.api(
               url,
              'GET',
              {"summary":"true"},
              function(response) {
                  console.log('response to likes API call: '+response);
                  if(response.summary.total_count==undefined){
                                          postNumLikes[k] = 0;  
                   }
                  else{
                       postNumLikes[k] = response.summary.total_count;
                  }
                  console.log("postNumLikes["+k+"] = "+postNumLikes[k]);
                  // Insert your code here
              }
            );
        })(k);
    }    
    setTimeout(drawGraph,20000);
    }
      
      
      function drawGraph() {   
        console.log("inside graph method now"); 

        var postDates = postsDates.slice(0);
        
        var postDates1 = [];
        
        for(var i in postDates) {
            postDates1[i] = (postDates[i].substring(0,10));
        }
        
        var postData = postNumLikes.slice(0);
        console.log("likes to be used in graph: "+postData);  
        
        var dataS = {
        labels: postDates1,
        datasets: [
            {
                label: "Test Graph",
                fillColor: "rgba(300,300,300,0.2)",
                strokeColor: "rgba(100,141,142,1)",
                pointColor: "rgba(220,100,0,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(220,220,220,1)",
                data: postData
            },  
        ]
    };
        var ctx = document.getElementById("myChart").getContext("2d");
        var myLineChart = new Chart(ctx).Line(dataS);
        // Get context with jQuery - using jQuery's .get() method.
        var ctx = $("#myChart").get(0).getContext("2d");
        // This will get the first returned node in the jQuery collection.
        var myNewChart = new Chart(ctx);
        new Chart(ctx).Line(dataS, {
                            scaleShowGridLines: false
                            });
        }
      
  </script>
              <!--
        Below we include the Login Button social plugin. This button uses
        the JavaScript SDK to present a graphical Login button that triggers
        the FB.login() function when clicked.
      -->  <fb:login-button scope="public_profile,email,user_posts" onlogin="checkLoginState();" data-max-rows="1" data-size="large" data-show-faces="true" data-auto-logout-link="false">
        </fb:login-button>
    
            <canvas id="myChart" width="500" height="500"></canvas>
    
</body>
    